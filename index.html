<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Rubricator 3000</title>

		<link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css" />
		<link
			rel="stylesheet"
			type="text/css"
			href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
		/>
		<link rel="stylesheet" href="./index.css" />

		<script src="index.js"></script>
		<script
			defer
			src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"
		></script>
		<script
			type="text/javascript"
			src="https://cdn.jsdelivr.net/npm/toastify-js"
		></script>
		<script defer src="//unpkg.com/alpinejs"></script>
		<script src="https://unpkg.com/feather-icons"></script>
	</head>
	<body>
		<main
			x-data="{
            revisadoPor: $persist(''),
            rubrics: 
            // $persist(
                {
                'example-0': platformerRubric,
                'example-1': shooterRubric,
                'example-2': arcadeRubric
            }
            // )
            ,
            selectedRubric: 
                // $persist(
                    'example-0'
                // )
                ,
            editing: false,
            checkedItems: {},
            isModalOpen: false,
            createNewRubric: function() {
                let newName = 'rubric-0';
                let i = 0;
                const nameSet = new Set(Object.values(this.rubrics).map(rubric => rubric.name));
                while (newName in nameSet) {
                    newName = `rubric-${i}`;
                } 

                const newId = `custom-${Date.now()}`;
                const newRubric = {
                    'id': newId,
                    'name': newName,
                    'rubric': exampleRubric
                }

                this.rubrics[newId] = newRubric;
                this.selectedRubric = newRubric.id;
                this.switchedRubric();
            },
            deleteRubric: function() {
                delete this.rubrics[this.selectedRubric];
                this.selectedRubric = Object.keys(this.rubrics)[0];
                this.switchedRubric();
                this.warningToast('Rubrica eliminada');
            },
            switchedRubric: function() {
                this.isModalOpen = false;
                this.editing = false 
            },
            deleteCriteria: function(subcategory, index) {
                subcategory.criteria.splice(index, 1);
            },
            deleteSubcategory: function(category, index) {
                category.subcategories.splice(index, 1);
            },
            deleteCategory: function(index) {
                this.rubrics[this.selectedRubric].rubric.splice(index, 1);
            },
            warningToast: function(message) {
                Toastify({
                    text: message,
                    duration: 3000,
                    className: 'toast-warning'
                }).showToast();
            },
            resetRubric: function() {
                for (const category of this.rubrics[this.selectedRubric].rubric) {
                    for (const subcategory of category.subcategories) {
                        for (const item of subcategory.criteria) {
                            item.checked = false;
                        }
                    }
                }
                this.warningToast('Rubrica reseteada');
            },
        }"
		>
            <div x-show="isModalOpen" class="modal" x-cloak>
                <div class="modal-content">
                    <p>¿Estás segurx que quieres eliminar esta rúbrica?</p>
                    <button @click="deleteRubric()" class="danger">Sí, eliminar</button>
                    <button @click="isModalOpen = false" class="info">Volver</button>
                  </div>
            </div>

            <div class="flex-center">
                <label for="revisadoPor" class="bottom-gap"
                    >Revisado por:
                    <input
                        id="revisadoPor"
                        type="text"
                        x-model="revisadoPor"
                        placeholder="Nombre"
                /></label>    
            </div>
			
            <div class="flex-center gap-half" x-show="!editing">
                <b>Rúbrica:</b>
                <select x-model="selectedRubric" @change="switchedRubric">
                    <template x-for="[id, rubric] of Object.entries(rubrics)">
                        <option
                            x-bind:value="id"
                            x-text="rubric.name"
                            :selected="selectedRubric===id"
                        ></option>
                    </template>
                </select>

                <button @click="createNewRubric()" title="Nueva rúbrica">
                    <i data-feather="plus-circle"></i>
                </button>
                <button
                    @click="isModalOpen = true"
                    class="danger"
                    title="Eliminar rúbrica"
                >
                    <i data-feather="trash-2"></i>
                </button>
                <button
                    @click="resetRubric()"
                    class="yellow"
                    title="Resetear rúbrica"
                >
                    <i data-feather="refresh-ccw"></i>
                </button>
                <button
                    @click="editing=true;feather.replace();"
                    class="info"
                    x-transition
                    title="Editar"
                >
                    <i data-feather="edit"></i>
                </button>
            </div>

            <div class="flex-center gap-half">
                <input
                    id="nombreRubrica"
                    type="text"
                    x-model="rubrics[selectedRubric].name"
                    placeholder="Nombre"
                    x-cloak
                    x-show="editing"
                />
                <button
                    @click="editing=false"
                    class="info"
                    x-cloak
                    x-show="editing"
                    title="Finalizar edición"
                >
                    <i data-feather="x"></i>
                </button>
            </div>

			<section>
				<div>todo: Puntos, Bonus, Nota</div>

				<ul :class="editing ? 'editing' : ''">
					<template
						x-for="category, index in rubrics[selectedRubric]['rubric']"
					>
						<li x-effect="feather.replace()">
							<u x-text="category.name" x-show="!editing"></u>
							<div class="inline-edit" x-show="editing" x-cloak>
								<button
									x-show="editing"
									x-cloak
									class="small-button danger"
									@click="deleteCategory(index)"
									title="Eliminar categoría"
								>
									<i data-feather="trash-2"></i>
								</button>
								<input type="text" x-model="category.name" />
							</div>

							<ul>
								<template
									x-for="(subcategory, index) in category.subcategories"
								>
									<li x-effect="feather.replace()">
										<span x-text="subcategory.name" x-show="!editing"></span>
										<div class="inline-edit" x-show="editing" x-cloak>
											<button
												x-show="editing"
												x-cloak
												class="small-button danger"
												@click="deleteSubcategory(category, index)"
												title="Eliminar subcategoría"
											>
												<i data-feather="trash-2"></i>
											</button>
											<input type="text" x-model="subcategory.name" />
										</div>

										<ul>
											<template x-for="(item, index) in subcategory.criteria">
												<li
													x-data="{'itemid': `${category}-${subcategory}-${item.name}-${index}`}"
													x-effect="feather.replace()"
												>
													<label :for="itemid" x-show="!editing">
														<input
															:id="itemid"
															:name="itemid"
															type="checkbox"
															x-model="item.checked"
														/>
														<code
															x-text="formatTypeAndValue(item.type, item.value)"
															:class="typeToClass(item.type)"
														></code>
														<span x-text="item.name"></span>
													</label>

													<div class="inline-edit" x-show="editing" x-cloak>
														<button
															x-show="editing"
															x-cloak
															class="small-button danger"
															@click="deleteCriteria(subcategory, index)"
															title="Eliminar criterio"
														>
															<i data-feather="trash-2"></i>
														</button>
														<input
															type="number"
															x-model="item.value"
															min="0"
															step="0.05"
														/>
														<input type="text" x-model="item.name" />
														<select x-model="item.type">
															<option value="0">Requisito</option>
															<option value="1">Descuento</option>
															<option value="2">Bonus</option>
														</select>
													</div>
												</li>
											</template>

											<li
												class="inline-edit new-edit"
												x-show="editing"
												x-cloak
												x-data="{
                                                newItem: structuredClone(itemTemplate),
                                                submitCriteria: function() {
                                                    if (!this.newItem.name) {
                                                        this.newItem.name = 'Nuevo Criterio'
                                                    }
                                                    if (!this.newItem.value) {
                                                        this.newItem.value = 0
                                                    }
                                                    if (isNaN(this.newItem.value)) {
                                                        this.warningToast('Error en valor del criterio')
                                                        return;
                                                    }
                                                    this.newItem.value = Math.abs(this.newItem.value)
                                                    subcategory.criteria.push(this.newItem)
                                                    this.newItem = structuredClone(itemTemplate)
                                                }
                                            }"
											>
												<button
													class="small-button"
													@click="submitCriteria()"
													title="Crear criterio"
												>
													<i data-feather="plus-circle"></i>
												</button>

												<input
													type="number"
													x-model="newItem.value"
													min="0"
													step="0.05"
													placeholder="0"
												/>
												<input
													type="text"
													x-model="newItem.name"
													placeholder="Nuevo Criterio"
												/>
												<select x-model="newItem.type">
													<option value="0">Requisito</option>
													<option value="1">Descuento</option>
													<option value="2">Bonus</option>
												</select>
											</li>
										</ul>
									</li>
								</template>

								<li
									class="inline-edit new-edit"
									x-show="editing"
									x-cloak
									x-data="{
                                        newSubcategory: structuredClone(subcategoryTemplate),
                                        submitSubcategory: function() {
                                            if (!this.newSubcategory.name) {
                                                this.newSubcategory.name = 'Nueva Subcategoría'
                                            }
                                            category.subcategories.push(this.newSubcategory)
                                            this.newSubcategory = structuredClone(subcategoryTemplate)
                                        }
                                    }"
								>
									<button
										class="small-button"
										@click="submitSubcategory()"
										title="Crear subcategoría"
									>
										<i data-feather="plus-circle"></i>
									</button>

									<input
										type="text"
										x-model="newSubcategory.name"
										placeholder="Nueva Subcategoría"
									/>
								</li>
							</ul>
						</li>
					</template>

					<li
						class="inline-edit new-edit"
						x-show="editing"
						x-cloak
						x-data="{
                            newCategory: structuredClone(categoryTemplate),
                            submitCategory: function() {
                                if (!this.newCategory.name) {
                                    this.newCategory.name = 'Nueva Categoría'
                                }
                                this.rubrics[this.selectedRubric].rubric.push(this.newCategory)
                                this.newCategory = structuredClone(categoryTemplate)
                            }
                        }"
					>
						<button
							class="small-button"
							@click="submitCategory()"
							title="Crear categoría"
						>
							<i data-feather="plus-circle"></i>
						</button>

						<input
							type="text"
							x-model="newCategory.name"
							placeholder="Nueva Categoría"
						/>
					</li>
				</ul>
			</section>

			<!-- Copy grading results -->
			<section>Resultado</section>
		</main>
		<footer>Página por: <a href="github.com/Nyveon">Eric K.</a></footer>

		<script defer>
			feather.replace();
		</script>
	</body>
</html>
